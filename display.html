<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Inventory Display</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 1400px; margin: 0 auto; background: #f0f2f5; color: #333; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        header h1 { margin: 0; font-size: 1.8rem; color: #1a1a1a; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn-outline { background: white; color: #007bff; border: 1px solid #007bff; }
        .btn-outline:hover { background: #f8f9fa; }

        /* Summary Card */
        .summary-card {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 40px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .summary-title { font-size: 1.1rem; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .summary-value { font-size: 2.5rem; font-weight: 700; margin: 0; }

        /* Grid Layout */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        
        /* Car Card */
        .card { background: white; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
        
        .card-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eaeaea; }
        .card-header h3 { margin: 0; font-size: 1.25rem; color: #2c3e50; }
        .card-id { font-size: 0.85rem; color: #6c757d; margin-top: 4px; }
        
        .card-body { padding: 20px; flex-grow: 1; }
        
        .field-group { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .field-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .label { color: #6c757d; font-size: 0.9rem; font-weight: 500; }
        .value { color: #212529; font-weight: 600; text-align: right; word-break: break-word; max-width: 60%; }
        
        .highlight-positive { color: #28a745; }
        .highlight-neutral { color: #007bff; }
        .section-header { margin-top: 15px; margin-bottom: 10px; font-size: 0.85rem; color: #999; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }

        /* Search */
        .search-container { margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-input { width: 100%; padding: 12px 20px; border: 2px solid #e9ecef; border-radius: 30px; font-size: 16px; outline: none; transition: border-color 0.2s; box-sizing: border-box; }
        .search-input:focus { border-color: #007bff; }

        /* Utilities */
        .error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 20px; border-radius: 8px; text-align: center; }
        .empty-state { grid-column: 1/-1; text-align: center; padding: 60px; color: #6c757d; background: white; border-radius: 12px; }
        
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .header-actions { width: 100%; justify-content: space-between; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Car Inventory</h1>
        <div class="header-actions">
            <a href="admin/" class="btn btn-outline">Back to Editor</a>
            <button onclick="loadData()" class="btn">Refresh Data</button>
        </div>
    </header>

    <div id="summary-container"></div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by Car Name, Owner, or VIN..." onkeyup="filterCards()">
    </div>

    <div id="cars-grid" class="grid">Loading...</div>

    <script>
        let allCars = [];

        async function loadData() {
            const grid = document.getElementById('cars-grid');
            
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Loading data...</p>';
            
            try {
                // Cache busting with timestamp
                const response = await fetch('content/data.json?v=' + Date.now(), { cache: "no-store" });
                if (!response.ok) {
                    if (response.status === 404) throw new Error('Data file not found (404)');
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error('Malformed JSON data in content/data.json');
                }
                
                if (!data || !data.cars || !Array.isArray(data.cars)) {
                    throw new Error('Invalid JSON structure: missing "cars" array');
                }

                allCars = data.cars;
                
                renderSummary(allCars);
                renderGrid(allCars);

            } catch (err) {
                const grid = document.getElementById('cars-grid');
                grid.innerHTML = `<div class="error">
                    <h3>Error Loading Data</h3>
                    <p>${err.message}</p>
                    <p>Please ensure <code>content/data.json</code> exists and has the correct schema.</p>
                </div>`;
            }
        }

        function formatMoney(amount) {
            if (amount == null || isNaN(amount)) return '0.00';
            return Number(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderSummary(cars) {
            // New Profit Logic: Sum of leftOverAndProfit (Calculated fresh)
            const totalProfit = cars.reduce((sum, car) => {
                const total = parseFloat(car.totalCostOfShipping) || 0;
                const shipping = parseFloat(car.shippingCost) || 0;
                const profit = total - shipping;
                return sum + profit;
            }, 0);

            const container = document.getElementById('summary-container');
            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">Total Profit (All Cars)</div>
                    <div class="summary-value">${formatMoney(totalProfit)}</div>
                </div>
            `;
        }

        function renderGrid(cars) {
            const grid = document.getElementById('cars-grid');
            
            if (cars.length === 0) {
                grid.innerHTML = '<div class="empty-state">No cars found. <a href="admin/">Add some in the editor!</a></div>';
                return;
            }

            grid.innerHTML = cars.map(car => {
                // New Logic Display
                const shippingCost = parseFloat(car.shippingCost) || 0;
                const totalCost = parseFloat(car.totalCostOfShipping) || 0;
                // Force calculation based on new rule to ensure accuracy
                const profit = (totalCost - shippingCost).toFixed(2);
                
                // Render payments based on Type
                const type = parseInt(car.arrivalOfPaymentType) || 1;
                let paymentsHtml = '';
                
                for (let i = 1; i <= 5; i++) {
                    // Show payments up to the Type count
                    if (i <= type) {
                        const amt = car[`arrivalPayment${i}Amount`];
                        const date = car[`arrivalPayment${i}Date`];
                        // Only show if fields exist to keep it clean, but requirement implies they are required for that type.
                        paymentsHtml += renderField(`Payment ${i}`, `${formatMoney(amt)} <small style="color:#888">(${date || 'No Date'})</small>`);
                    }
                }

                return `
                <div class="card">
                    <div class="card-header">
                        <h3>${escapeHtml(car.carName || 'Unnamed Car')}</h3>
                        <div class="card-id">ID: ${escapeHtml(car.id || 'N/A')}</div>
                    </div>
                    <div class="card-body">
                        ${renderField('Owner', car.carOwnerName)}
                        ${renderField('VIN', car.vin)}
                        ${renderField('Purchase Date', car.purchaseDate)}
                        ${renderField('Arrival Date', car.arrivalDate)}
                        
                        <div class="section-header">Financials</div>
                        ${renderField('Total Cost of Shipping', formatMoney(totalCost))}
                        ${renderField('Shipping Cost', formatMoney(shippingCost))}
                        ${renderField('Shipping Pay Date', car.shippingCostPaymentDate)}
                        ${renderField('Njoom Shipping Cost', formatMoney(car.njoomShippingCost))}
                        ${renderField('Car Total Cost', formatMoney(car.carTotalCost))}
                        ${renderField('Profit / Left Over', formatMoney(profit), 'highlight-positive')}
                        
                        <div class="section-header">Payments (Type ${type})</div>
                        ${paymentsHtml}

                        <div class="section-header">Notes</div>
                        <div class="field-group" style="display: block;">
                            <div class="value" style="text-align: left; max-width: 100%; white-space: pre-wrap;">${escapeHtml(car.notes || 'No notes available.')}</div>
                        </div>

                        <!-- Export Button -->
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                            <button onclick="exportToPDF(this.getAttribute('data-id'))" data-id="${escapeHtml(car.id)}" class="btn" style="width: 100%; background: #343a40; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Export to PDF
                            </button>
                        </div>
                    </div>
                </div>
            `}).join(''); 
        }

        function renderField(label, value, className = '') {
            if (value === null || value === undefined || value === '') return ''; 
            return `
                <div class="field-group">
                    <span class="label">${escapeHtml(label)}</span>
                    <span class="value ${className}">${value}</span> 
                </div>
            `; 
        }   

        function filterCards() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCars.filter(car => {
                const name = (car.carName || '').toLowerCase();
                const owner = (car.carOwnerName || '').toLowerCase();
                const vin = (car.vin || '').toLowerCase();
                return name.includes(query) || owner.includes(query) || vin.includes(query);
            });
            
            renderGrid(filtered);
        }

        function escapeHtml(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function exportToPDF(carId) {
            const car = allCars.find(c => c.id === carId);
            if (!car) return alert('Car not found!');

            // Get absolute logo path
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const logoUrl = baseUrl + 'logo.png';

            const purchaseCost = parseFloat(car.purchaseCost) || 0;
            const totalCost = parseFloat(car.carTotalCost) || 0;
            const njoomCost = formatMoney(car.njoomShippingCost);
            
            // Signature
            let signatureHtml = '';
            if (car.signature) {
                signatureHtml = `<img src="${car.signature}" class="signature-img" alt="Signature">`;
            } else {
                signatureHtml = `<div class="no-signature">(No signature)</div>`;
            }

            // Payment Plan Section
            const installmentCount = parseInt(car.arrivalOfPaymentType) || 1;
            let paymentRows = '';
            for (let i = 1; i <= installmentCount; i++) {
                const amount = car[`arrivalPayment${i}Amount`];
                const date = car[`arrivalPayment${i}Date`];
                paymentRows += `
                    <tr>
                        <td>Payment ${i} / الدفعة ${i}</td>
                        <td>${amount ? formatMoney(amount) : '—'}</td>
                        <td>${date ? escapeHtml(date) : '—'}</td>
                    </tr>
                `;
            }

            const paymentSectionHtml = `
                <div class="section-title">Car Payment / دفع السيارة – ${installmentCount} Installments / أقساط</div>
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Payment Number / رقم الدفعة</th>
                            <th>Payment Amount / مبلغ الدفعة</th>
                            <th>Payment Date / تاريخ الدفعة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paymentRows}
                    </tbody>
                </table>
            `;

            const win = window.open('', '_blank');
            const html = `
           <!DOCTYPE html>
<html>
<head>
    <title>Receipt - ${escapeHtml(car.carName)}</title>
    <style>
        body {
            background-color: #323333;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color: #333;
            display: flex;
            justify-content: center;
        }
        @page {
            size: A4;
            margin: 10mm;
        }
        .receipt-container {
            width: 100%;
            max-width: 800px;
            background: linear-gradient(180deg, #D4B77B 0%, #8D7146 50%, #D4B77B 100%);
            position: relative;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            color: #323333;
        }
        .logo-img {
            max-height: 100px;
            display: block;
            margin: 0 auto 20px auto;
        }
        .company-info {
            text-align: center;
            font-size: 11px;
            color: #333;
            margin-bottom: 5px;
        }
        .invoice-number {
            text-align: right;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #323333;
        }
        .section-title {
            background-color: #333;
            color: #D4B77B;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .info-label {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: bold;
            color: #1a1a1a;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.4);
        }
        .info-value {
            padding: 8px 10px;
            font-size: 12px;
            color: #000;
            font-weight: bold;
        }
        .total-section {
            margin-top: 20px;
            border: 2px solid #333;
            padding: 15px;
            background: rgba(255,255,255,0.2);
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }
        .total-label {
            font-weight: bold;
            color: #111;
        }
        .total-value {
            font-weight: bold;
            color: #000;
            font-size: 16px;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
            background: rgba(255,255,255,0.5);
        }
        .details-table th {
            background-color: #333;
            color: #D4B77B;
            padding: 8px;
            text-align: left;
            border: 1px solid #333;
        }
        .details-table td {
            padding: 8px;
            border: 1px solid #666;
            color: #000;
        }
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        .signature-img {
            max-height: 80px;
            max-width: 200px;
        }
        .footer {
            text-align: right;
            font-size: 10px;
            color: #111;
            margin-top: 30px;
        }
        @media print {
            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
            }
            .receipt-container {
                 box-shadow: none;
                 width: 100%;
                 max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container">
        <img src="${logoUrl}" alt="Logo" class="logo-img">
        
        <div class="invoice-number">ID: ${escapeHtml(car.id)}</div>
        
        <div class="section-title">Receipt Information / معلومات الإيصال</div>
        
        <div class="info-grid">
            <div class="info-row">
                <div class="info-label">Owner Name / اسم المالك</div>
                <div class="info-value">${escapeHtml(car.carOwnerName)}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Car Name / اسم السيارة</div>
                <div class="info-value">${escapeHtml(car.carName)}</div>
            </div>
         
            <div class="info-row">
                <div class="info-label">VIN / رقم الشاصي</div>
                <div class="info-value">${escapeHtml(car.vin)}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Purchase Date / تاريخ الشراء</div>
                <div class="info-value">${escapeHtml(car.purchaseDate)}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Arrival Date / تاريخ الوصول</div>
                <div class="info-value">${escapeHtml(car.arrivalDate)}</div>
            </div>
        </div>

        <table class="details-table">
            <thead>
                <tr>
                    <th>Car Shipping Details / تفاصيل شحن السيارة</th>
                    <th>Credit / دائن (AED)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Njoom Shipping Cost / تكلفة شحن نجوم</td>
                    <td>${njoomCost}</td>
                </tr>
            </tbody>
        </table>

        ${paymentSectionHtml}
                
        <div class="total-section">
            <div class="total-row">
                <span class="total-label">Total Cost / التكلفة الإجمالية</span>
                <span class="total-value">${formatMoney(totalCost)}</span>
            </div>
        </div>
        <div class="signature-section">
            <div class="info-label" style="display: inline-block; margin-bottom: 10px; background: none; border: none; padding-left: 0;">Signature</div>
            <br>
            ${signatureHtml}
        </div>
        
        <div class="footer">
            Printed in ${new Date().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true })}
        </div>
    </div>
    <script>
        window.onload = function() {
            setTimeout(function() { window.print(); }, 500);
        }
    <\/script>
</body>
</html>
            `;

            win.document.write(html);
            win.document.close();
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
